generator client {
  // Prisma Client 生成器提供者
  provider = "prisma-client"
  // 生成的客户端输出目录
  output   = "../generated/prisma"
}

datasource db {
  // 数据库类型
  provider = "postgresql"
  // 使用的数据库 schema 列表
  schemas  = ["auth", "collections", "docs", "public"]
}

/// 会话表：存储用户会话令牌、过期时间、撤销时间等（schema: auth）
model Session {
  // 会话ID（UUID）
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  // 用户ID
  userId    Int
  // 会话令牌哈希
  tokenHash String    @unique
  // 创建时间
  createdAt DateTime  @default(now()) @db.Timestamp(6)
  // 过期时间
  expiresAt DateTime  @db.Timestamp(6)
  // 撤销时间
  revokedAt DateTime? @db.Timestamp(6)
  // 登录IP
  ip        String?   @db.VarChar(255)
  // 用户代理（User-Agent）
  userAgent String?
  // 关联用户
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_session_user")

  @@index([expiresAt], map: "idx_session_expiresat")
  @@index([userId], map: "idx_session_userid")
  @@schema("auth")
}

/// 用户表：存储用户名、密码、邮箱等基础信息（schema: auth）
model User {
  // 用户ID
  id        Int       @id @default(autoincrement())
  // 用户名
  username  String    @unique @db.VarChar(255)
  // 密码（建议存储哈希值）
  password  String    @db.VarChar(255)
  // 邮箱
  email     String?   @db.VarChar(255)
  // 创建时间
  createdAt DateTime  @default(now()) @db.Timestamp(6)
  // 更新时间
  updatedAt DateTime  @default(now()) @db.Timestamp(6)
  // 关联会话列表
  Session   Session[]

  @@schema("auth")
}

/// 项目表：包含项目名称、权重、状态、是否验证权限、时间戳与软删除（schema: collections）
model Project {
  // 项目ID
  id          BigInt   @id @default(autoincrement()) @db.BigInt
  // 项目名称
  projectName String   @db.VarChar(128)
  // 项目头像（存储相对路径或URL）
  avatar      String?  @db.VarChar(500)
  // 权重/排序
  weight      Int
  // 状态
  status      Int      @db.SmallInt
  // 是否需要鉴权
  requireAuth Boolean  @default(false)
  // 创建时间
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  // 更新时间
  updatedAt   DateTime @default(now()) @db.Timestamptz(6)
  // 软删除标记
  isDeleted   Boolean  @default(false)

  // 项目版本列表
  versions ProjectVersion[]
  // 项目菜单列表
  menus    ProjectMenu[]
  // 项目首页（一对一）
  home     ProjectHome?

  @@schema("collections")
}

/// 项目菜单表：项目顶部导航菜单，支持二级层级结构（schema: collections）
model ProjectMenu {
  // 菜单ID
  id         BigInt   @id @default(autoincrement()) @db.BigInt
  // 项目ID（外键）
  projectId  BigInt   @db.BigInt
  // 父级菜单ID（NULL表示一级菜单）
  parentId   BigInt?  @db.BigInt
  // 菜单文本
  label      String   @db.VarChar(64)
  // 跳转链接（支持站内/站外）
  url        String?  @db.VarChar(2048)
  // 是否外链（true=新窗口打开）
  isExternal Boolean  @default(false)
  // 权重/排序（数值越大越靠前）
  weight     Int      @default(0)
  // 状态（1=启用，0=禁用）
  status     Int      @db.SmallInt @default(1)
  // 创建时间
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  // 更新时间
  updatedAt  DateTime @default(now()) @db.Timestamptz(6)
  // 软删除标记
  isDeleted  Boolean  @default(false)

  // 关联项目
  project  Project       @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_project_menu_project")
  // 父级菜单（自引用）
  parent   ProjectMenu?  @relation("MenuHierarchy", fields: [parentId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_project_menu_parent")
  // 子级菜单列表
  children ProjectMenu[] @relation("MenuHierarchy")

  @@index([projectId], map: "idx_project_menu_projectid")
  @@index([parentId], map: "idx_project_menu_parentid")
  @@schema("collections")
}

/// 项目首页表：存储项目首页的 Markdown 内容（schema: collections）
model ProjectHome {
  // 首页ID
  id        BigInt   @id @default(autoincrement()) @db.BigInt
  // 项目ID（外键，唯一约束保证一对一）
  projectId BigInt   @unique @db.BigInt
  // Markdown 内容
  content   String   @db.Text
  // 状态（1=启用，0=禁用）
  status    Int      @default(1) @db.SmallInt
  // 创建时间
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  // 更新时间
  updatedAt DateTime @default(now()) @db.Timestamptz(6)
  // 软删除标记
  isDeleted Boolean  @default(false)

  // 关联项目
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_project_home_project")

  @@index([projectId], map: "idx_project_home_projectid")
  @@schema("collections")
}

/// 项目版本表：关联项目，包含版本号、简介、权重、状态、时间戳与软删除（schema: collections）
model ProjectVersion {
  // 项目版本ID
  id          BigInt   @id @default(autoincrement()) @db.BigInt
  // 项目ID
  projectId   BigInt   @db.BigInt
  // 版本号
  version     String   @db.VarChar(64)
  // 版本简介
  description String?  @db.Text
  // 权重/排序
  weight      Int
  // 状态
  status      Int      @db.SmallInt
  // 创建时间
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  // 更新时间
  updatedAt   DateTime @default(now()) @db.Timestamptz(6)
  // 软删除标记
  isDeleted   Boolean  @default(false)

  // 关联项目
  project    Project    @relation(fields: [projectId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_project_version_project")
  // 分类列表
  categories Category[]

  @@index([projectId], map: "idx_project_version_projectid")
  @@schema("collections")
}

/// 分类表：关联项目版本，包含分类名称、权重、状态、时间戳与软删除（schema: collections）
model Category {
  // 分类ID
  id               BigInt   @id @default(autoincrement()) @db.BigInt
  // 项目版本ID
  projectVersionId BigInt   @db.BigInt
  // 分类名称
  categoryName     String   @db.VarChar(64)
  // 权重/排序
  weight           Int
  // 状态
  status           Int      @db.SmallInt
  // 创建时间
  createdAt        DateTime @default(now()) @db.Timestamptz(6)
  // 更新时间
  updatedAt        DateTime @default(now()) @db.Timestamptz(6)
  // 软删除标记
  isDeleted        Boolean  @default(false)

  // 关联项目版本
  projectVersion ProjectVersion @relation(fields: [projectVersionId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_category_project_version")
  // 笔记信息列表
  noteInfos      NoteInfo[]

  @@index([projectVersionId], map: "idx_category_projectversionid")
  @@schema("collections")
}

/// 笔记信息表：关联分类，包含笔记标题、权重、状态、时间戳与软删除（schema: docs）
model NoteInfo {
  // 笔记信息ID
  id         BigInt   @id @default(autoincrement()) @db.BigInt
  // 分类ID
  categoryId BigInt   @db.BigInt
  // 笔记标题
  noteTitle  String   @db.VarChar(255)
  // 权重/排序
  weight     Int
  // 状态
  status     Int      @db.SmallInt
  // 创建时间
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  // 更新时间
  updatedAt  DateTime @default(now()) @db.Timestamptz(6)
  // 软删除标记
  isDeleted  Boolean  @default(false)

  // 关联分类
  category Category      @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_noteinfo_category")
  // 内容版本列表
  contents NoteContent[]

  @@index([categoryId], map: "idx_noteinfo_categoryid")
  @@schema("docs")
}

/// 笔记内容表：一对多多版本，包含正文内容、类型、版本备注、主显示标记、状态、时间戳与软删除（schema: docs）
model NoteContent {
  // 笔记内容ID
  id          BigInt   @id @default(autoincrement()) @db.BigInt
  // 笔记信息ID
  noteInfoId  BigInt   @db.BigInt 
  // 正文内容
  content     String   @db.Text
  // 版本备注
  versionNote String?  @db.VarChar(255)
  // 是否主显示版本
  isPrimary   Boolean  @default(false)
  // 状态
  status      Int      @db.SmallInt
  // 创建时间
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  // 更新时间
  updatedAt   DateTime @default(now()) @db.Timestamptz(6)
  // 软删除标记
  isDeleted   Boolean  @default(false)

  // 关联笔记信息
  noteInfo    NoteInfo         @relation(fields: [noteInfoId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_notecontent_noteinfo")

  @@index([noteInfoId], map: "idx_notecontent_noteinfoid")
  @@schema("docs")
}

/// 文件管理表：存储上传文件的原始信息、服务器落盘信息与业务类型（schema: public）
model FileManagement {
  // 文件ID
  id BigInt @id @default(autoincrement()) @db.BigInt

  // 原始文件名
  originalName String @db.VarChar(255) @map("original_name")
  // 服务器文件名
  fileName     String @db.VarChar(255) @map("file_name")
  // 相对路径
  filePath     String @db.VarChar(500) @map("file_path")
  // 文件大小(byte)
  fileSize     BigInt @db.BigInt @map("file_size")

  //  avatar/homework/attachment
  businessType String @db.VarChar(50) @map("business_type")

  // 1正常 0删除
  status       Int    @default(1) @db.SmallInt
  createTime   DateTime @default(now()) @db.Timestamp(6) @map("create_time")

  @@map("file_management")
  @@schema("public")
}


/// 系统配置表：存储系统级配置项（schema: public）
model SystemConfig {
  // 配置ID
  id          BigInt   @id @default(autoincrement()) @db.BigInt
  // 配置键（唯一）
  configKey   String   @unique @db.VarChar(100) @map("config_key")
  // 配置值
  configValue String   @db.VarChar(500) @map("config_value")
  // 配置描述
  description String?  @db.VarChar(255)
  // 创建时间
  createdAt   DateTime @default(now()) @db.Timestamptz(6) @map("created_at")
  // 更新时间
  updatedAt   DateTime @default(now()) @db.Timestamptz(6) @map("updated_at")

  @@map("system_config")
  @@schema("public")
}

/// Merkle Tree 表：存储系统级 cNFT Merkle Tree 信息（schema: public）
model MerkleTree {
  // 树ID
  id               BigInt   @id @default(autoincrement()) @db.BigInt
  // 树名称
  name             String   @db.VarChar(128)
  // 链上树地址
  treeAddress      String   @unique @db.VarChar(64) @map("tree_address")
  // 树权限地址（公钥）
  treeAuthority    String   @db.VarChar(64) @map("tree_authority")
  // 加密后的树权限私钥（AES-256-GCM 加密）用于解密铸造
  encryptedKey     String   @db.Text @map("encrypted_key")
  // 创建者钱包地址
  creatorAddress   String   @db.VarChar(64) @map("creator_address")
  // 最大深度（决定容量：2^maxDepth）
  maxDepth         Int      @db.SmallInt @map("max_depth")
  // 最大缓冲区大小
  maxBufferSize    Int      @db.SmallInt @map("max_buffer_size")
  // 树冠深度（减少证明大小）
  canopyDepth      Int      @db.SmallInt @map("canopy_depth")
  // 网络类型：mainnet / devnet
  network          String   @db.VarChar(20) @default("devnet")
  // 已铸造数量
  totalMinted      Int      @default(0) @map("total_minted")
  // 最大容量
  maxCapacity      BigInt   @db.BigInt @map("max_capacity")
  // 创建成本（lamports）
  creationCost     BigInt   @db.BigInt @map("creation_cost")
  // 创建交易签名
  txSignature      String?  @db.VarChar(128) @map("tx_signature")
  // 优先级（数值越大越优先使用，用于多树冗余）
  priority         Int      @default(0)
  // 状态：0=创建中 1=正常 2=已满 -1=失败
  status           Int      @default(0) @db.SmallInt
  // 创建时间
  createdAt        DateTime @default(now()) @db.Timestamptz(6) @map("created_at")
  // 更新时间
  updatedAt        DateTime @default(now()) @db.Timestamptz(6) @map("updated_at")
  // 软删除标记
  isDeleted        Boolean  @default(false) @map("is_deleted")

  // 关联的 cNFT 列表
  cnfts CompressedNft[]

  @@index([network, status], map: "idx_merkle_tree_network_status")
  @@index([creatorAddress], map: "idx_merkle_tree_creator")
  @@map("merkle_tree")
  @@schema("public")
}

/// 压缩 NFT 表：存储 cNFT 元数据，关联项目用于鉴权（schema: public）
model CompressedNft {
  // cNFT ID
  id              BigInt   @id @default(autoincrement()) @db.BigInt
  // 所属 Merkle Tree ID
  merkleTreeId    BigInt   @db.BigInt @map("merkle_tree_id")
  // 关联项目 ID（用于鉴权，哪个项目的访问权限）
  projectId       BigInt   @db.BigInt @map("project_id")
  // 资产 ID（链上唯一标识）
  assetId         String   @unique @db.VarChar(64) @map("asset_id")
  // 叶子索引
  leafIndex       Int      @map("leaf_index")
  // NFT 名称
  name            String   @db.VarChar(128)
  // NFT 符号
  symbol          String?  @db.VarChar(32)
  // NFT 描述
  description     String?  @db.Text
  // 元数据 URI（ipfs://CID 格式）
  metadataUri     String?  @db.VarChar(500) @map("metadata_uri")
  // 图片 IPFS CID
  imageCid        String?  @db.VarChar(128) @map("image_cid")
  // 元数据 IPFS CID
  metadataCid     String?  @db.VarChar(128) @map("metadata_cid")
  // 原始图片文件 ID（关联 FileManagement）
  originalImageId BigInt?  @db.BigInt @map("original_image_id")
  // 当前持有者地址
  ownerAddress    String   @db.VarChar(64) @map("owner_address")
  // 铸造交易签名
  mintTxSignature String?  @db.VarChar(128) @map("mint_tx_signature")
  // 状态：0=铸造中 1=正常 -1=失败
  status          Int      @default(0) @db.SmallInt
  // 创建时间
  createdAt       DateTime @default(now()) @db.Timestamptz(6) @map("created_at")
  // 更新时间
  updatedAt       DateTime @default(now()) @db.Timestamptz(6) @map("updated_at")

  // 关联 Merkle Tree
  merkleTree MerkleTree @relation(fields: [merkleTreeId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_cnft_merkle_tree")

  @@index([merkleTreeId], map: "idx_cnft_merkle_tree_id")
  @@index([projectId], map: "idx_cnft_project_id")
  @@index([ownerAddress], map: "idx_cnft_owner")
  @@index([projectId, ownerAddress], map: "idx_cnft_project_owner")
  @@map("compressed_nft")
  @@schema("public")
}
